def configure(cnf):
    import sys
    import os
    from waflib import Logs

    cnf.env.APP_NAME = 'host'

    # Only build Moddable tools when js-engine is moddable
    if cnf.env.JS_ENGINE != 'moddable':
        return

    Logs.pprint('CYAN', 'Building Moddable tools and host app...')

    # Set MODDABLE environment variable
    moddable_path = cnf.path.find_node('moddable').abspath()

    # Determine platform-specific build directory
    if sys.platform == 'darwin':
        platform_dir = 'mac'
    elif sys.platform.startswith('linux'):
        platform_dir = 'lin'
    elif sys.platform.startswith('win'):
        platform_dir = 'win'
    else:
        cnf.fatal('Unsupported platform: {}'.format(sys.platform))

    # Prepare environment with MODDABLE and updated PATH
    tools_path = os.path.join(moddable_path, 'build', 'bin', platform_dir, 'release')
    env = os.environ.copy()
    env['MODDABLE'] = moddable_path
    env['PATH'] = tools_path + os.pathsep + env.get('PATH', '')

    # Build Moddable tools
    makefiles_dir = os.path.join(moddable_path, 'build', 'makefiles', platform_dir)
    Logs.pprint('CYAN', 'Building Moddable tools in {}...'.format(makefiles_dir))
    ret = cnf.exec_command('make', cwd=makefiles_dir, env=env)
    if ret != 0:
        cnf.fatal('Failed to build Moddable tools')

    # Compile Moddable host app
    host_dir = os.path.join(moddable_path, 'build', 'devices', 'pebble', 'host')
    Logs.pprint('CYAN', 'Compiling Moddable host app in {}...'.format(host_dir))
    ret = cnf.exec_command('mcconfig -m -p pebble', cwd=host_dir, env=env)
    if ret != 0:
        cnf.fatal('Failed to compile Moddable host app')

    Logs.pprint('GREEN', 'Moddable tools and host app built successfully')

def build(bld):
    if bld.env.JS_ENGINE != 'moddable':
        return
    libxs_sources = [
        'moddable/build/devices/esp/lib/bsearch/bsearch.c',
        'moddable/build/devices/pebble/lib/qsort/qsort.c',
        'moddable/xs/platforms/mc/xsHosts.c',
        'moddable/xs/platforms/pebble/xsHost.c',
        'moddable/xs/platforms/pebble/xsPlatform.c',
        'moddable/xs/sources/xsAPI.c',
        'moddable/xs/sources/xsAll.c',
        'moddable/xs/sources/xsArguments.c',
        'moddable/xs/sources/xsArray.c',
        'moddable/xs/sources/xsAtomics.c',
        'moddable/xs/sources/xsBigInt.c',
        'moddable/xs/sources/xsBoolean.c',
        'moddable/xs/sources/xsCode.c',
        'moddable/xs/sources/xsCommon.c',
        'moddable/xs/sources/xsDataView.c',
        'moddable/xs/sources/xsDate.c',
        'moddable/xs/sources/xsDebug.c',
        'moddable/xs/sources/xsError.c',
        'moddable/xs/sources/xsFunction.c',
        'moddable/xs/sources/xsGenerator.c',
        'moddable/xs/sources/xsGlobal.c',
        'moddable/xs/sources/xsJSON.c',
        'moddable/xs/sources/xsLexical.c',
        'moddable/xs/sources/xsLockdown.c',
        'moddable/xs/sources/xsMapSet.c',
        'moddable/xs/sources/xsMarshall.c',
        'moddable/xs/sources/xsMath.c',
        'moddable/xs/sources/xsMemory.c',
        'moddable/xs/sources/xsModule.c',
        'moddable/xs/sources/xsNumber.c',
        'moddable/xs/sources/xsObject.c',
        'moddable/xs/sources/xsPlatforms.c',
        'moddable/xs/sources/xsProfile.c',
        'moddable/xs/sources/xsPromise.c',
        'moddable/xs/sources/xsProperty.c',
        'moddable/xs/sources/xsProxy.c',
        'moddable/xs/sources/xsRegExp.c',
        'moddable/xs/sources/xsRun.c',
        'moddable/xs/sources/xsScope.c',
        'moddable/xs/sources/xsScript.c',
        'moddable/xs/sources/xsSnapshot.c',
        'moddable/xs/sources/xsSourceMap.c',
        'moddable/xs/sources/xsString.c',
        'moddable/xs/sources/xsSymbol.c',
        'moddable/xs/sources/xsSyntaxical.c',
        'moddable/xs/sources/xsTree.c',
        'moddable/xs/sources/xsType.c',
        'moddable/xs/sources/xsdtoa.c',
        'moddable/xs/sources/xsmc.c',
        'moddable/xs/sources/xsre.c',
        'moddable/xs/tools/fdlibm/e_acos.c',
        'moddable/xs/tools/fdlibm/e_acosh.c',
        'moddable/xs/tools/fdlibm/e_asin.c',
        'moddable/xs/tools/fdlibm/e_atan2.c',
        'moddable/xs/tools/fdlibm/e_atanh.c',
        'moddable/xs/tools/fdlibm/e_cosh.c',
        'moddable/xs/tools/fdlibm/e_exp.c',
        'moddable/xs/tools/fdlibm/e_fmod.c',
        'moddable/xs/tools/fdlibm/e_hypot.c',
        'moddable/xs/tools/fdlibm/e_log.c',
        'moddable/xs/tools/fdlibm/e_log10.c',
        'moddable/xs/tools/fdlibm/e_pow.c',
        'moddable/xs/tools/fdlibm/e_rem_pio2.c',
        'moddable/xs/tools/fdlibm/e_sinh.c',
        'moddable/xs/tools/fdlibm/k_cos.c',
        'moddable/xs/tools/fdlibm/k_exp.c',
        'moddable/xs/tools/fdlibm/k_rem_pio2.c',
        'moddable/xs/tools/fdlibm/k_sin.c',
        'moddable/xs/tools/fdlibm/k_tan.c',
        'moddable/xs/tools/fdlibm/s_asinh.c',
        'moddable/xs/tools/fdlibm/s_atan.c',
        'moddable/xs/tools/fdlibm/s_cbrt.c',
        'moddable/xs/tools/fdlibm/s_ceil.c',
        'moddable/xs/tools/fdlibm/s_cos.c',
        'moddable/xs/tools/fdlibm/s_expm1.c',
        'moddable/xs/tools/fdlibm/s_log1p.c',
        'moddable/xs/tools/fdlibm/s_scalbn.c',
        'moddable/xs/tools/fdlibm/s_sin.c',
        'moddable/xs/tools/fdlibm/s_tan.c',
        'moddable/xs/tools/fdlibm/s_tanh.c',
        'moddable/xs/tools/fdlibm/s_trunc.c',
        'moddable/modules/io/common/builtinCommon.c',
        'moddable/modules/files/resource/Resource.c',
        'moddable/modules/base/easing/easing.c',
        'moddable/modules/base/debug/modDebug.c',
        'moddable/modules/base/instrumentation/modInstrumentation.c',
        'moddable/modules/base/time/pebble/modTime.c',
        'moddable/modules/base/timer/modTimer.c',
        'moddable/modules/base/timer/pebble/timer.c',
        'moddable/modules/io/storage/pebble/storage-pebble.c',
        'moddable/modules/commodetto/commodettoParseBMF.c',
        'moddable/modules/commodetto/commodettoParseBMP.c',
        'moddable/modules/commodetto/commodettoParseRLE.c',
        'moddable/modules/commodetto/commodettoBitmap.c',
        'moddable/modules/commodetto/commodettoPocoCore.c',
        'moddable/build/devices/pebble/modules/pocoblit/commodettoPocoBlit-pebble.c',
        'moddable/modules/commodetto/cfeBMF.c',
        'moddable/modules/data/qrcode/qrcode.c',
        'moddable/modules/data/url/url.c',
        'moddable/modules/piu/All/piuApplication.c',
        'moddable/modules/piu/All/piuBehavior.c',
        'moddable/modules/piu/All/piuColor.c',
        'moddable/modules/piu/All/piuColumn.c',
        'moddable/modules/piu/All/piuContent.c',
        'moddable/modules/piu/All/piuContainer.c',
        'moddable/modules/piu/All/piuLabel.c',
        'moddable/modules/piu/All/piuLayout.c',
        'moddable/modules/piu/All/piuLocals.c',
        'moddable/modules/piu/All/piuPort.c',
        'moddable/modules/piu/All/piuRectangle.c',
        'moddable/modules/piu/All/piuRow.c',
        'moddable/modules/piu/All/piuScroller.c',
        'moddable/modules/piu/All/piuSkin.c',
        'moddable/modules/piu/All/piuStyle.c',
        'moddable/modules/piu/All/piuText.c',
        'moddable/modules/piu/All/piuTimeline.c',
        'moddable/modules/piu/All/piuTransition.c',
        'moddable/modules/piu/Pebble/piuFont.c',
        'moddable/modules/piu/Pebble/piuInverter.c',
        'moddable/modules/piu/Pebble/piuQRCode.c',
        'moddable/modules/piu/Pebble/piuRoundRect.c',
        'moddable/modules/piu/Pebble/piuScreenBuffer.c',
        'moddable/modules/piu/Pebble/piuSVGImage.c',
        'moddable/modules/piu/Pebble/piuTexture.c',
        'moddable/modules/piu/Pebble/piuView.c',
        'moddable/build/devices/pebble/modules/display/pebble-display.c',
        'moddable/build/devices/pebble/modules/poco/poco-pebble.c',
        'moddable/build/devices/pebble/modules/button/pebblebutton.c',
        'moddable/build/devices/pebble/modules/global/pebble-global.c',
        'moddable/build/devices/pebble/modules/message/pebble-appmessage.c',
        'moddable/build/devices/pebble/modules/accelerometer/pebble-accelerometer.c',
        'moddable/build/devices/pebble/modules/battery/pebble-battery.c',
        'moddable/build/devices/pebble/modules/compass/pebble-compass.c',
        'moddable/modules/io/files/pebble/files-pebble.c',
        'moddable/build/tmp/pebble/release/host/mc.xs.c',
        'moddable/build/tmp/pebble/release/host/mc.resources.c',
        'moddable/build/devices/pebble/modules/archive-resource/Archive.c',
        'moddable/build/devices/pebble/modules/archive-resource/ArchivePebbleResource.c',
        'moddable/build/devices/pebble/host/main-appinfo.c',
    ]

    libxs_includes = [
        'moddable/xs/includes',
        'moddable/xs/sources',
        'moddable/xs/platforms/mc',
        'moddable/xs/platforms/pebble',
        'moddable/xs/tools/fdlibm',
        'moddable/modules/base/timer',
        'moddable/modules/base/instrumentation',
        'moddable/modules/commodetto/gif',
        'moddable/modules/commodetto',
        'moddable/modules/io/common',
        'moddable/modules/piu/All',
        'moddable/modules/piu/MC',
        'moddable/build/tmp/pebble/release/host',
    ]

    libxs_flags = [
        '-Og',
        '-Dpebble',
        '-DmxUseDefaultSharedChunks=1',
        '-DkCommodettoBitmapFormat=kCommodettoBitmapMonochromeAligned',
        '-DkPocoRotation=0',
        '-DkPocoFrameBuffer=1',
        '-DMODGCC=1',
        '-DMODINSTRUMENTATION=1',
        '-DmxInstrument',
        '-DmxUseDefaultSharedChunks=1',
        '-fno-strict-aliasing',
        '-fomit-frame-pointer',
        '-fshort-enums',
        '-mlittle-endian',
        '-mthumb-interwork',
        '-mtp=soft',
        '-munaligned-access',
        '-Wno-error=clobbered',
        '-Wno-error=sign-compare',
        '-Wno-error=strict-aliasing',
        '-Wno-misleading-indentation']

    bld(export_includes=libxs_includes, name='libxs_includes')

    xs_includes_use=['libxs_includes',
                     'freertos_includes',
                     'fw_includes']

    bld.stlib(	source=libxs_sources,
                cflags=libxs_flags,
                export_includes=libxs_includes,
                target='libxs',
                use=xs_includes_use)
